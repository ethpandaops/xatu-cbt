name: test
on:
  pull_request:
  workflow_dispatch:
    inputs:
      xatu_ref:
        description: 'Xatu repository ref to checkout'
        required: false
        default: 'master'
        type: string
permissions:
  contents: read
jobs:
  discover-tests:
    name: Discover test directories
    runs-on:
      - ubuntu-latest
    outputs:
      tests: ${{ steps.set-tests.outputs.tests }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - id: set-tests
        run: |
          if [ -d "tests" ]; then
            # Find network/spec directories (e.g., mainnet/pectra, sepolia/fusaka)
            tests=$(find tests -mindepth 2 -maxdepth 2 -type d | sed 's|^tests/||' | jq -R -s -c 'split("\n")[:-1]')
            echo "tests=${tests}" >> $GITHUB_OUTPUT
            echo "Found tests: ${tests}"
          else
            echo "tests=[]" >> $GITHUB_OUTPUT
            echo "No tests directory found"
          fi
  run-tests:
    name: Test ${{ matrix.test }}
    needs: discover-tests
    if: needs.discover-tests.outputs.tests != '[]'
    runs-on:
      - ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test: ${{ fromJson(needs.discover-tests.outputs.tests) }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Check external models have test data
        run: |
          echo "Checking external models have corresponding test data..."
          echo "Test path: tests/${{ matrix.test }}/data"
          missing_data=""
          if [ -d "models/external" ]; then
            while IFS= read -r model_file; do
              model_name=$(basename "$model_file" | cut -d. -f1)
              if [ ! -f "tests/${{ matrix.test }}/data/${model_name}.yaml" ] && \
                 [ ! -f "tests/${{ matrix.test }}/data/${model_name}.yml" ]; then
                missing_data="${missing_data}${model_name} "
              fi
            done < <(find models/external -type f -name "*.go" -o -name "*.sql" -o -name "*.yaml" -o -name "*.yml")
          fi
          if [ -n "$missing_data" ]; then
            echo "ERROR: Missing test data for external models: ${missing_data}"
            exit 1
          fi
          echo "✓ All external models have test data"
      - name: Check all models have assertions
        run: |
          echo "Checking all models have corresponding assertions..."
          echo "Test path: tests/${{ matrix.test }}/assertions"
          missing_assertions=""
          if [ -d "models" ]; then
            while IFS= read -r model_file; do
              model_name=$(basename "$model_file" | cut -d. -f1)
              if [ ! -f "tests/${{ matrix.test }}/assertions/${model_name}.yaml" ] && \
                 [ ! -f "tests/${{ matrix.test }}/assertions/${model_name}.yml" ]; then
                missing_assertions="${missing_assertions}${model_name} "
              fi
            done < <(find models -type f -name "*.go" -o -name "*.sql" -o -name "*.yaml" -o -name "*.yml")
          fi
          if [ -n "$missing_assertions" ]; then
            echo "ERROR: Missing assertions for models: ${missing_assertions}"
            exit 1
          fi
          echo "✓ All models have assertions"
      - name: Set up env
        run: |
          cp example.env .env
      - name: Checkout Xatu
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: ethpandaops/xatu
          ref: ${{ github.event.inputs.xatu_ref || 'master' }}
          path: xatu
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: '1.24'
      - name: Build xatu-cbt
        run: make build
      - name: Run test ${{ matrix.test }}
        run: ./bin/xatu-cbt test ${{ matrix.test }}
