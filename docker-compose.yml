volumes:
  cbt-config:

services:
  cbt-redis:
    image: redis:7-alpine
    container_name: cbt-redis-${NETWORK}
    # No volume mount - Redis data should not persist across test runs
    # This ensures a clean state when containers are restarted
    command: redis-server
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - xatu_xatu-net

  # Config setup container
  cbt-config-setup:
    image: busybox:latest
    container_name: cbt-config-setup-${NETWORK}
    volumes:
      - cbt-config:/config
      - ./overrides.yaml:/overrides.yaml:ro
      - ./overrides.tests.yaml:/overrides.tests.yaml:ro
    environment:
      - TESTING=${TESTING:-false}
    command:
      - /bin/sh
      - -c
      - |
        cat > /config/${NETWORK}.yaml << EOF
        logging: debug
        metricsAddr: ":9090"
        healthCheckAddr: ":8080"
        clickhouse:
          url: http://${CLICKHOUSE_USERNAME}:${CLICKHOUSE_PASSWORD}@xatu-clickhouse-01:8123
          cluster: "{cluster}"
          localSuffix: "_local"
          adminDatabase: ${NETWORK}
          adminTable: admin_cbt
        redis:
          url: "redis://cbt-redis-${NETWORK}:6379/0"
        scheduler:
          concurrency: 10
          consolidation: "@every 10m"
        worker:
          concurrency: 10
        models:
          external:
            defaultDatabase: ${NETWORK}
          transformations:
            defaultDatabase: ${NETWORK}
        EOF
        # Apply appropriate overrides based on TESTING environment variable
        if [ "$TESTING" = "true" ]; then
          if [ -f /overrides.tests.yaml ] && [ -s /overrides.tests.yaml ]; then
            echo "# Overrides from overrides.tests.yaml (TESTING mode)" >> /config/${NETWORK}.yaml
            cat /overrides.tests.yaml >> /config/${NETWORK}.yaml
            echo "Test overrides appended to config file"
          fi
        else
          if [ -f /overrides.yaml ] && [ -s /overrides.yaml ]; then
            echo "# Overrides from overrides.yaml" >> /config/${NETWORK}.yaml
            cat /overrides.yaml >> /config/${NETWORK}.yaml
            echo "Overrides appended to config file"
          fi
        fi
        echo "Config file created successfully"

  # CBT Engine
  cbt-engine:
    image: ethpandaops/cbt:debian-latest
    container_name: cbt-engine-${NETWORK}
    depends_on:
      cbt-redis:
        condition: service_healthy
      cbt-config-setup:
        condition: service_completed_successfully
      # cbt-clickhouse-migrator:
      #   condition: service_completed_successfully
    volumes:
      - ./models:/models:ro
      - cbt-config:/config:ro
    command: ["--config", "/config/${NETWORK}.yaml"]
    restart: unless-stopped
    networks:
      - xatu_xatu-net
    deploy:
      replicas: 1

networks:
  xatu_xatu-net:
    external: true
