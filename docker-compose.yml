volumes:
  cbt-config:

services:
  cbt-redis:
    image: redis:7-alpine
    container_name: cbt-redis
    # No volume mount - Redis data should not persist across test runs
    # This ensures a clean state when containers are restarted
    command: redis-server
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - xatu_xatu-net

  # Config setup container
  cbt-config-setup:
    image: busybox:latest
    container_name: cbt-config-setup
    volumes:
      - cbt-config:/config
    command:
      - /bin/sh
      - -c
      - |
        cat > /config/config.yaml << EOF
        logging: debug
        metricsAddr: ":9090"
        healthCheckAddr: ":8080"
        clickhouse:
          url: http://xatu-clickhouse-01:8123
          cluster: "{cluster}"
          localSuffix: "_local"
          adminDatabase: ${NETWORK:-mainnet}
          adminTable: admin_cbt
        redis:
          url: "redis://cbt-redis:6379/0"
        scheduler:
          concurrency: 10
          consolidation: "@every 10m"
        worker:
          concurrency: 10
        models:
          database: ${NETWORK:-mainnet}
          defaultDatabase: ${NETWORK:-mainnet}
          external:
            database: ${NETWORK:-mainnet}
            defaultDatabase: ${NETWORK:-mainnet}
          transformations:
            database: ${NETWORK:-mainnet}
            defaultDatabase: ${NETWORK:-mainnet}
        EOF
        echo "Config file created successfully"

  # CBT Engine
  cbt-engine:
    image: ethpandaops/cbt:latest
    container_name: cbt-engine
    depends_on:
      cbt-redis:
        condition: service_healthy
      cbt-config-setup:
        condition: service_completed_successfully
      # cbt-clickhouse-migrator:
      #   condition: service_completed_successfully
    volumes:
      - ./models:/models:ro
      - cbt-config:/config:ro
    command: ["--config", "/config/config.yaml"]
    restart: unless-stopped
    networks:
      - xatu_xatu-net
    deploy:
      replicas: 1

networks:
  xatu_xatu-net:
    external: true
