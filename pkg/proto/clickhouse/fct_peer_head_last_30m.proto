syntax = "proto3";

package cbt;

import "common.proto";
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "clickhouse/annotations.proto";

option go_package = "github.com/ethpandaops/xatu-cbt/pkg/proto/clickhouse";
// Aggregated peer head distribution from the last 30 minutes of handle_status events

message FctPeerHeadLast30m {
  // Timestamp when the record was last updated
  uint32 updated_date_time = 11;
  // The head slot reported by peers
  uint32 head_slot = 12;
  // The head block root reported by peers (unknown if not available)
  string head_root = 13;
  // Total number of peers at this head
  uint32 peer_count = 14;
  // Peer count breakdown by client implementation
  map<string, uint32> count_by_client = 15;
  // Peer count breakdown by country
  map<string, uint32> count_by_country = 16;
  // Peer count breakdown by continent code
  map<string, uint32> count_by_continent = 17;
  // Peer count breakdown by fork digest
  map<string, uint32> count_by_fork_digest = 18;
  // Peer count breakdown by platform (os)
  map<string, uint32> count_by_platform = 19;
  // Peer count breakdown by finalized epoch
  map<string, uint32> count_by_finalized_epoch = 20;
}

// Request for listing fct_peer_head_last_30m records
message ListFctPeerHeadLast30mRequest {
  // Filter by head_slot - The head slot reported by peers (PRIMARY KEY - required)
  UInt32Filter head_slot = 1 [(google.api.field_behavior) = REQUIRED, (clickhouse.v1.required_group) = "primary_key"];

  // Filter by head_root - The head block root reported by peers (unknown if not available) (ORDER BY column 2 - optional)
  StringFilter head_root = 2 [(google.api.field_behavior) = OPTIONAL];

  // Filter by updated_date_time - Timestamp when the record was last updated (optional)
  UInt32Filter updated_date_time = 3 [(google.api.field_behavior) = OPTIONAL];
  // Filter by peer_count - Total number of peers at this head (optional)
  UInt32Filter peer_count = 4 [(google.api.field_behavior) = OPTIONAL];
  // Filter by count_by_client - Peer count breakdown by client implementation (optional)
  MapStringUInt32Filter count_by_client = 5 [(google.api.field_behavior) = OPTIONAL];
  // Filter by count_by_country - Peer count breakdown by country (optional)
  MapStringUInt32Filter count_by_country = 6 [(google.api.field_behavior) = OPTIONAL];
  // Filter by count_by_continent - Peer count breakdown by continent code (optional)
  MapStringUInt32Filter count_by_continent = 7 [(google.api.field_behavior) = OPTIONAL];
  // Filter by count_by_fork_digest - Peer count breakdown by fork digest (optional)
  MapStringUInt32Filter count_by_fork_digest = 8 [(google.api.field_behavior) = OPTIONAL];
  // Filter by count_by_platform - Peer count breakdown by platform (os) (optional)
  MapStringUInt32Filter count_by_platform = 9 [(google.api.field_behavior) = OPTIONAL];
  // Filter by count_by_finalized_epoch - Peer count breakdown by finalized epoch (optional)
  MapStringUInt32Filter count_by_finalized_epoch = 10 [(google.api.field_behavior) = OPTIONAL];

  // The maximum number of fct_peer_head_last_30m to return.
  // If unspecified, at most 100 items will be returned.
  // The maximum value is 10000; values above 10000 will be coerced to 10000.
  int32 page_size = 11 [(google.api.field_behavior) = OPTIONAL];
  // A page token, received from a previous `ListFctPeerHeadLast30m` call.
  // Provide this to retrieve the subsequent page.
  string page_token = 12 [(google.api.field_behavior) = OPTIONAL];
  // The order of results. Format: comma-separated list of fields.
  // Example: "foo,bar" or "foo desc,bar" for descending order on foo.
  // If unspecified, results will be returned in the default order.
  string order_by = 13 [(google.api.field_behavior) = OPTIONAL];
}

// Response for listing fct_peer_head_last_30m records
message ListFctPeerHeadLast30mResponse {
  // The list of fct_peer_head_last_30m.
  repeated FctPeerHeadLast30m fct_peer_head_last_30m = 1;
  // A token, which can be sent as `page_token` to retrieve the next page.
  // If this field is omitted, there are no subsequent pages.
  string next_page_token = 2;
}

// Request for getting a single fct_peer_head_last_30m record by primary key
message GetFctPeerHeadLast30mRequest {
  // The head slot reported by peers
  uint32 head_slot = 1; // Primary key (required)
}

// Response for getting a single fct_peer_head_last_30m record
message GetFctPeerHeadLast30mResponse {
  FctPeerHeadLast30m item = 1;
}

// Query fct_peer_head_last_30m data
service FctPeerHeadLast30mService {
  // List records | Retrieve paginated results with optional filtering
  rpc List(ListFctPeerHeadLast30mRequest) returns (ListFctPeerHeadLast30mResponse) {
    option (google.api.http) = {
      get: "/api/v1/fct_peer_head_last_30m"
    };
  }
  // Get record | Retrieve a single record by head_slot
  rpc Get(GetFctPeerHeadLast30mRequest) returns (GetFctPeerHeadLast30mResponse) {
    option (google.api.http) = {
      get: "/api/v1/fct_peer_head_last_30m/{head_slot}"
    };
  }
}
