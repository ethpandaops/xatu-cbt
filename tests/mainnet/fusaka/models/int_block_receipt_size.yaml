model: int_block_receipt_size
network: mainnet
spec: fusaka
external_data:
    canonical_execution_logs:
        url: https://data.ethpandaops.io/xatu-cbt/mainnet/fusaka/int_block_receipt_size_canonical_execution_logs.parquet
        network_column: meta_network_name
    canonical_execution_transaction:
        url: https://data.ethpandaops.io/xatu-cbt/mainnet/fusaka/int_block_receipt_size_canonical_execution_transaction.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS row_count FROM int_block_receipt_size FINAL
      assertions:
        - type: greater_than
          column: row_count
          value: 0
    - name: No negative receipt_bytes values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_receipt_size FINAL
        WHERE receipt_bytes < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Transaction count must be at least 1 per block
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_receipt_size FINAL
        WHERE transaction_count < 1
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No negative log_count or log_data_bytes or log_topic_count
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_receipt_size FINAL
        WHERE log_count < 0
           OR log_data_bytes < 0
           OR log_topic_count < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: avg_receipt_bytes_per_transaction must not exceed max_receipt_bytes_per_transaction
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_receipt_size FINAL
        WHERE avg_receipt_bytes_per_transaction > max_receipt_bytes_per_transaction
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: p50 must not exceed p95 (percentile ordering)
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_receipt_size FINAL
        WHERE p50_receipt_bytes_per_transaction > p95_receipt_bytes_per_transaction
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: p95 must not exceed max receipt bytes per transaction
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_receipt_size FINAL
        WHERE p95_receipt_bytes_per_transaction > max_receipt_bytes_per_transaction
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: receipt_bytes must be at least max_receipt_bytes_per_transaction (sum >= max)
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_receipt_size FINAL
        WHERE receipt_bytes < max_receipt_bytes_per_transaction
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No null meta_network_name values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_receipt_size FINAL
        WHERE meta_network_name IS NULL OR meta_network_name = ''
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Each block_number should be unique per meta_network_name
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM (
          SELECT block_number, meta_network_name, COUNT(*) AS dupes
          FROM int_block_receipt_size FINAL
          GROUP BY block_number, meta_network_name
          HAVING dupes > 1
        )
      assertions:
        - type: equals
          column: bad_rows
          value: 0
