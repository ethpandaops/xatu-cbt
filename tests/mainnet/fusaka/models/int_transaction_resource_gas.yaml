model: int_transaction_resource_gas
network: mainnet
spec: fusaka
external_data:
    canonical_execution_traces:
        url: https://data.ethpandaops.io/xatu-cbt/mainnet/fusaka/int_transaction_resource_gas_canonical_execution_traces.parquet
        network_column: meta_network_name
    canonical_execution_transaction:
        url: https://data.ethpandaops.io/xatu-cbt/mainnet/fusaka/int_transaction_resource_gas_canonical_execution_transaction.parquet
        network_column: meta_network_name
    canonical_execution_transaction_structlog_agg:
        url: https://data.ethpandaops.io/xatu-cbt/mainnet/fusaka/int_transaction_resource_gas_canonical_execution_transaction_structlog_agg.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS row_count FROM int_transaction_resource_gas FINAL
      assertions:
        - type: greater_than
          column: row_count
          value: 0
    - name: No duplicate transaction entries per block
      sql: |
        SELECT COUNT(*) AS duplicate_count
        FROM (
          SELECT block_number, transaction_hash, COUNT(*) AS cnt
          FROM int_transaction_resource_gas FINAL
          GROUP BY block_number, transaction_hash
          HAVING cnt > 1
        )
      assertions:
        - type: equals
          column: duplicate_count
          value: 0
    - name: gas_compute meets minimum intrinsic cost of 8500
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM int_transaction_resource_gas FINAL
        WHERE gas_compute < 8500
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: gas_block_size meets minimum intrinsic cost of 5700
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM int_transaction_resource_gas FINAL
        WHERE gas_block_size < 5700
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: gas_history meets minimum intrinsic cost of 6500
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM int_transaction_resource_gas FINAL
        WHERE gas_history < 6500
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: gas_address_access meets minimum intrinsic cost of 300
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM int_transaction_resource_gas FINAL
        WHERE gas_address_access < 300
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No null transaction_hash values
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM int_transaction_resource_gas FINAL
        WHERE transaction_hash IS NULL OR transaction_hash = ''
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Total resource gas per transaction is reasonable (at least 21000 intrinsic)
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM (
          SELECT
            block_number,
            transaction_hash,
            gas_compute + gas_memory + gas_address_access + gas_state_growth
              + gas_history + gas_bloom_topics + gas_block_size AS total_resource_gas
          FROM int_transaction_resource_gas FINAL
        )
        WHERE total_resource_gas < 21000
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: transaction_index is non-negative
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM int_transaction_resource_gas FINAL
        WHERE transaction_index < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: meta_network_name is not empty
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM int_transaction_resource_gas FINAL
        WHERE meta_network_name IS NULL OR meta_network_name = ''
      assertions:
        - type: equals
          column: bad_rows
          value: 0
