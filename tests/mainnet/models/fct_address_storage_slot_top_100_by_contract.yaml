model: fct_address_storage_slot_top_100_by_contract
network: mainnet
external_data:
    canonical_execution_storage_diffs:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/fct_address_storage_slot_top_100_by_contract_canonical_execution_storage_diffs.parquet
        network_column: meta_network_name
    canonical_execution_storage_reads:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/fct_address_storage_slot_top_100_by_contract_canonical_execution_storage_reads.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS row_count FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: greater_than
          column: row_count
          value: 0
    - name: Row count should not exceed 100 due to LIMIT
      sql: |
        SELECT COUNT(*) AS row_count FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: less_than_or_equal
          column: row_count
          value: 100
    - name: Rank should start at 1
      sql: |
        SELECT MIN(rank) AS min_rank FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: equals
          column: min_rank
          value: 1
    - name: Rank should not exceed 100
      sql: |
        SELECT MAX(rank) AS max_rank FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: less_than_or_equal
          column: max_rank
          value: 100
    - name: No duplicate ranks
      sql: |
        SELECT COUNT(*) - COUNT(DISTINCT rank) AS duplicate_ranks FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: equals
          column: duplicate_ranks
          value: 0
    - name: No duplicate contract addresses
      sql: |
        SELECT COUNT(*) - COUNT(DISTINCT contract_address) AS duplicate_addresses FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: equals
          column: duplicate_addresses
          value: 0
    - name: No null contract addresses
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_address_storage_slot_top_100_by_contract FINAL
        WHERE contract_address IS NULL OR contract_address = ''
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: All total_storage_slots should be at least 1
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_address_storage_slot_top_100_by_contract FINAL
        WHERE total_storage_slots < 1
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Results should be ordered by total_storage_slots descending (rank 1 has the most)
      sql: |
        SELECT COUNT(*) AS bad_rows FROM (
          SELECT rank, total_storage_slots,
            leadInFrame(total_storage_slots) OVER (ORDER BY rank ASC ROWS BETWEEN CURRENT ROW AND 1 FOLLOWING) AS next_slots
          FROM fct_address_storage_slot_top_100_by_contract FINAL
        )
        WHERE next_slots > 0 AND total_storage_slots < next_slots
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No null updated_date_time values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_address_storage_slot_top_100_by_contract FINAL
        WHERE updated_date_time IS NULL
      assertions:
        - type: equals
          column: bad_rows
          value: 0
