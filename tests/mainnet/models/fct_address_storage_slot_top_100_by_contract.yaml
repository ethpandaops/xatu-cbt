model: fct_address_storage_slot_top_100_by_contract
network: mainnet
external_data:
    canonical_execution_storage_diffs:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/fct_address_storage_slot_top_100_by_contract_canonical_execution_storage_diffs.parquet
        network_column: meta_network_name
    canonical_execution_storage_reads:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/fct_address_storage_slot_top_100_by_contract_canonical_execution_storage_reads.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS row_count FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: greater_than
          column: row_count
          value: 0
    - name: Row count should be at most 100
      sql: |
        SELECT COUNT(*) AS row_count FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: less_than_or_equal
          column: row_count
          value: 100
    - name: No null contract addresses
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_address_storage_slot_top_100_by_contract FINAL
        WHERE contract_address = '' OR contract_address IS NULL
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: All ranks should be between 1 and 100
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_address_storage_slot_top_100_by_contract FINAL
        WHERE rank < 1 OR rank > 100
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No duplicate ranks
      sql: |
        SELECT COUNT(*) - COUNT(DISTINCT rank) AS duplicate_ranks FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: equals
          column: duplicate_ranks
          value: 0
    - name: Total storage slots should be positive for all rows
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_address_storage_slot_top_100_by_contract FINAL
        WHERE total_storage_slots <= 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No duplicate contract addresses
      sql: |
        SELECT COUNT(*) - COUNT(DISTINCT contract_address) AS duplicate_addresses FROM fct_address_storage_slot_top_100_by_contract FINAL
      assertions:
        - type: equals
          column: duplicate_addresses
          value: 0
    - name: Ranks should be ordered by total_storage_slots descending
      sql: |
        SELECT COUNT(*) AS bad_rows FROM (
          SELECT rank, total_storage_slots,
            lagInFrame(total_storage_slots) OVER (ORDER BY rank ASC) AS prev_slots
          FROM fct_address_storage_slot_top_100_by_contract FINAL
        )
        WHERE prev_slots < total_storage_slots
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Updated date time should not be in the future
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_address_storage_slot_top_100_by_contract FINAL
        WHERE updated_date_time > now()
      assertions:
        - type: equals
          column: bad_rows
          value: 0
