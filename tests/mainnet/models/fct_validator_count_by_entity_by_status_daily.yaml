model: fct_validator_count_by_entity_by_status_daily
network: mainnet
external_data:
    canonical_beacon_validators:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/fct_validator_count_by_entity_by_status_daily_canonical_beacon_validators.parquet
        network_column: meta_network_name
    ethseer_validator_entity:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/fct_validator_count_by_entity_by_status_daily_ethseer_validator_entity.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS row_count FROM fct_validator_count_by_entity_by_status_daily FINAL
      assertions:
        - type: greater_than
          column: row_count
          value: 0
    - name: No zero or negative validator counts
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_validator_count_by_entity_by_status_daily FINAL
        WHERE validator_count <= 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No null day_start_date values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_validator_count_by_entity_by_status_daily FINAL
        WHERE day_start_date IS NULL OR day_start_date = toDate('1970-01-01')
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No empty entity values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_validator_count_by_entity_by_status_daily FINAL
        WHERE entity = ''
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No empty status values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_validator_count_by_entity_by_status_daily FINAL
        WHERE status = ''
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No null updated_date_time values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_validator_count_by_entity_by_status_daily FINAL
        WHERE updated_date_time = toDateTime('1970-01-01 00:00:00')
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No duplicate day-entity-status combinations
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM (
            SELECT day_start_date, entity, status, COUNT(*) AS combo_count
            FROM fct_validator_count_by_entity_by_status_daily FINAL
            GROUP BY day_start_date, entity, status
            HAVING combo_count > 1
        )
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: day_start_date should be reasonable (not in the future or before beacon chain genesis)
      sql: |
        SELECT COUNT(*) AS bad_rows FROM fct_validator_count_by_entity_by_status_daily FINAL
        WHERE day_start_date > today() + 1
           OR day_start_date < toDate('2020-12-01')
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Total validator count per day should be reasonable
      sql: |
        SELECT MIN(daily_total) AS min_daily_total
        FROM (
            SELECT day_start_date, SUM(validator_count) AS daily_total
            FROM fct_validator_count_by_entity_by_status_daily FINAL
            GROUP BY day_start_date
        )
      assertions:
        - type: greater_than
          column: min_daily_total
          value: 0
