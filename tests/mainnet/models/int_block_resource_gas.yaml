model: int_block_resource_gas
network: mainnet
external_data:
    canonical_execution_traces:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/int_block_resource_gas_canonical_execution_traces.parquet
        network_column: meta_network_name
    canonical_execution_transaction:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/int_block_resource_gas_canonical_execution_transaction.parquet
        network_column: meta_network_name
    canonical_execution_transaction_structlog_agg:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/int_block_resource_gas_canonical_execution_transaction_structlog_agg.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS row_count FROM int_block_resource_gas FINAL
      assertions:
        - type: greater_than
          column: row_count
          value: 0
    - name: No null block numbers
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_resource_gas FINAL
        WHERE block_number IS NULL
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Block numbers should be positive
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_resource_gas FINAL
        WHERE block_number <= 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No negative gas_compute values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_resource_gas FINAL
        WHERE gas_compute < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No negative gas_memory values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_resource_gas FINAL
        WHERE gas_memory < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No negative gas_address_access values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_resource_gas FINAL
        WHERE gas_address_access < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No negative gas_state_growth or gas_history values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_resource_gas FINAL
        WHERE gas_state_growth < 0 OR gas_history < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No null meta_network_name
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_resource_gas FINAL
        WHERE meta_network_name IS NULL OR meta_network_name = ''
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No duplicate block_number per meta_network_name
      sql: |
        SELECT COUNT(*) AS duplicate_groups FROM (
          SELECT block_number, meta_network_name
          FROM int_block_resource_gas FINAL
          GROUP BY block_number, meta_network_name
          HAVING COUNT(*) > 1
        )
      assertions:
        - type: equals
          column: duplicate_groups
          value: 0
    - name: Gas refund should not exceed total of all other gas components per block
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_block_resource_gas FINAL
        WHERE gas_refund > (gas_compute + gas_memory + gas_address_access + gas_state_growth + gas_history + gas_bloom_topics + gas_block_size)
      assertions:
        - type: equals
          column: bad_rows
          value: 0
