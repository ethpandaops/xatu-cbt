model: int_execution_block_by_date
network: mainnet
external_data:
    canonical_execution_block:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/int_execution_block_by_date_canonical_execution_block.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS row_count FROM int_execution_block_by_date FINAL
      assertions:
        - type: greater_than
          column: row_count
          value: 0
    - name: No null block_number values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_execution_block_by_date FINAL
        WHERE block_number IS NULL
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No negative block_number values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_execution_block_by_date FINAL
        WHERE block_number < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No null block_date_time values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_execution_block_by_date FINAL
        WHERE block_date_time IS NULL
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No null updated_date_time values
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_execution_block_by_date FINAL
        WHERE updated_date_time IS NULL
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No duplicate block_number entries
      sql: |
        SELECT COUNT(*) AS bad_rows FROM (
          SELECT block_number, COUNT(*) AS cnt
          FROM int_execution_block_by_date FINAL
          GROUP BY block_number
          HAVING cnt > 1
        )
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: block_date_time should not be in the far future
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_execution_block_by_date FINAL
        WHERE block_date_time > now() + INTERVAL 1 DAY
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: block_date_time should be after Ethereum genesis
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_execution_block_by_date FINAL
        WHERE block_date_time < toDateTime('2015-07-30 00:00:00')
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: updated_date_time should not be a zero timestamp
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_execution_block_by_date FINAL
        WHERE updated_date_time = toDateTime('1970-01-01 00:00:00')
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: block_number ordering is consistent with block_date_time
      sql: |
        SELECT COUNT(*) AS bad_rows FROM (
          SELECT block_number, block_date_time,
            lagInFrame(block_number) OVER (ORDER BY block_date_time) AS prev_block
          FROM int_execution_block_by_date FINAL
        )
        WHERE prev_block > 0 AND block_number < prev_block
      assertions:
        - type: equals
          column: bad_rows
          value: 0
