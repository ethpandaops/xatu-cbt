model: int_transaction_receipt_size
network: mainnet
external_data:
    canonical_execution_logs:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/int_transaction_receipt_size_canonical_execution_logs.parquet
        network_column: meta_network_name
    canonical_execution_transaction:
        url: https://data.ethpandaops.io/xatu-cbt/tests/mainnet/int_transaction_receipt_size_canonical_execution_transaction.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS row_count FROM int_transaction_receipt_size FINAL
      assertions:
        - type: greater_than
          column: row_count
          value: 0
    - name: No null transaction hashes
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_transaction_receipt_size FINAL
        WHERE transaction_hash IS NULL OR transaction_hash = ''
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Receipt bytes must meet minimum RLP envelope size
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_transaction_receipt_size FINAL
        WHERE receipt_bytes < 265
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No negative log counts
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_transaction_receipt_size FINAL
        WHERE log_count < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No negative log data bytes
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_transaction_receipt_size FINAL
        WHERE log_data_bytes < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Log topic count must not exceed four per log
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_transaction_receipt_size FINAL
        WHERE log_topic_count > log_count * 4
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Transactions with zero logs must have zero log data bytes and zero topic count
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_transaction_receipt_size FINAL
        WHERE log_count = 0 AND (log_data_bytes != 0 OR log_topic_count != 0)
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No duplicate transaction hashes within the same block
      sql: |
        SELECT COUNT(*) AS bad_rows
        FROM (
          SELECT block_number, transaction_hash, COUNT(*) AS dupes
          FROM int_transaction_receipt_size FINAL
          GROUP BY block_number, transaction_hash
          HAVING dupes > 1
        )
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: Transaction index must be non-negative
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_transaction_receipt_size FINAL
        WHERE transaction_index < 0
      assertions:
        - type: equals
          column: bad_rows
          value: 0
    - name: No null meta network name
      sql: |
        SELECT COUNT(*) AS bad_rows FROM int_transaction_receipt_size FINAL
        WHERE meta_network_name IS NULL OR meta_network_name = ''
      assertions:
        - type: equals
          column: bad_rows
          value: 0
