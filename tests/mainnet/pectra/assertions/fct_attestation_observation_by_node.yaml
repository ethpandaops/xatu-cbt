- name: "Expected bounds and size"
  sql: |
    SELECT
      COUNT(*) AS count,
      MIN(slot_start_date_time) AS min,
      MAX(slot_start_date_time) AS max
    FROM
      fct_attestation_observation_by_node FINAL
  expected:
    count: 558
    min: "2025-07-15T08:34:23Z"
    max: "2025-07-15T08:38:11Z"

- name: "Expected admin bounds"
  sql: |
    SELECT
      fromUnixTimestamp(MAX(position + interval)) AS max,
      fromUnixTimestamp(MIN(position)) AS min
    FROM
      admin_cbt_incremental FINAL
    WHERE
      table = 'fct_attestation_observation_by_node'
  expected:
    max: "2025-07-15T08:38:11Z"
    min: "2025-07-15T08:34:23Z"

- name: "Attestation count totals match source"
  sql: |
    WITH source_count AS (
      SELECT COUNT(*) AS total
      FROM int_attestation_first_seen FINAL
    ),
    fact_count AS (
      SELECT SUM(attestation_count) AS total
      FROM fct_attestation_observation_by_node FINAL
    )
    SELECT
      s.total AS source_total,
      f.total AS fact_total,
      (f.total - s.total) AS difference
    FROM source_count s, fact_count f
  expected:
    source_total: 683483
    fact_total: 683483
    difference: 0

- name: "Attestation metrics validation"
  sql: |
    SELECT
      MIN(attestation_count) AS min_count,
      MAX(attestation_count) >= 1 AS has_attestations,
      MAX(attestation_count) <= 100000 AS max_count_reasonable,
      MIN(min_seen_slot_start_diff) >= 0 AS fastest_valid,
      MAX(max_seen_slot_start_diff) <= 1000000 AS slowest_reasonable,
      MIN(median_seen_slot_start_diff) >= 0 AS median_valid,
      MAX(median_seen_slot_start_diff) <= 1000000 AS median_reasonable,
      COUNT(DISTINCT meta_client_name) >= 10 AS has_nodes
    FROM
      fct_attestation_observation_by_node FINAL
  expected:
    min_count: 1
    has_attestations: 1
    max_count_reasonable: 1
    fastest_valid: 1
    slowest_reasonable: 1
    median_valid: 1
    median_reasonable: 1
    has_nodes: 1

- name: "No rows with zero attestations"
  sql: |
    SELECT COUNT(*) AS invalid_rows
    FROM fct_attestation_observation_by_node FINAL
    WHERE attestation_count = 0
  expected:
    invalid_rows: 0

- name: "Average latency is non-negative"
  sql: |
    SELECT
      MIN(avg_seen_slot_start_diff) >= 0 AS min_avg_valid
    FROM fct_attestation_observation_by_node FINAL
  expected:
    min_avg_valid: 1
