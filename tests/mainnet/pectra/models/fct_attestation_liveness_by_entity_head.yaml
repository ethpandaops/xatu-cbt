model: fct_attestation_liveness_by_entity_head
network: mainnet
spec: pectra
external_data:
    beacon_api_eth_v1_beacon_committee:
        url: https://data.ethpandaops.io/xatu-cbt/pectra/beacon_api_eth_v1_beacon_committee.parquet
        network_column: meta_network_name
    beacon_api_eth_v1_events_attestation:
        url: https://data.ethpandaops.io/xatu-cbt/pectra/beacon_api_eth_v1_events_attestation.parquet
        network_column: meta_network_name
    beacon_api_eth_v1_events_block:
        url: https://data.ethpandaops.io/xatu-cbt/pectra/beacon_api_eth_v1_events_block.parquet
        network_column: meta_network_name
    beacon_api_eth_v1_events_block_gossip:
        url: https://data.ethpandaops.io/xatu-cbt/pectra/beacon_api_eth_v1_events_block_gossip.parquet
        network_column: meta_network_name
    beacon_api_eth_v1_proposer_duty:
        url: https://data.ethpandaops.io/xatu-cbt/pectra/beacon_api_eth_v1_proposer_duty.parquet
        network_column: meta_network_name
    libp2p_gossipsub_beacon_attestation:
        url: https://data.ethpandaops.io/xatu-cbt/pectra/libp2p_gossipsub_beacon_attestation.parquet
        network_column: meta_network_name
    libp2p_gossipsub_beacon_block:
        url: https://data.ethpandaops.io/xatu-cbt/pectra/libp2p_gossipsub_beacon_block.parquet
        network_column: meta_network_name
    ethseer_validator_entity:
        url: https://data.ethpandaops.io/xatu-cbt/pectra/ethseer_validator_entity.parquet
        network_column: meta_network_name
assertions:
    - name: Expected size
      sql: |
        SELECT
          COUNT(*) AS count,
          MIN(slot) AS min,
          MAX(slot) AS max
        FROM
          fct_attestation_liveness_by_entity_head FINAL
      expected:
        count: 20
        max: "12145389"
        min: "12145370"
    - name: Expected distinct slots
      sql: |
        SELECT
          COUNT(DISTINCT slot) AS slot_count
        FROM
          fct_attestation_liveness_by_entity_head FINAL
      expected:
        slot_count: 20
    - name: No NULL entities
      sql: |
        SELECT
          COUNT(*) as null_entity_count
        FROM
          fct_attestation_liveness_by_entity_head FINAL
        WHERE
          entity IS NULL
      expected:
        null_entity_count: 0
    - name: Entity defaults to unknown when not mapped
      sql: |
        SELECT
          COUNT(DISTINCT entity) as entity_count,
          SUM(CASE WHEN entity = 'unknown' THEN 1 ELSE 0 END) as unknown_count
        FROM
          fct_attestation_liveness_by_entity_head FINAL
      expected:
        entity_count: 1
        unknown_count: 20
    - name: Total attestation count matches validator table
      sql: |
        SELECT
          SUM(attestation_count) + SUM(missed_count) AS total_from_aggregated
        FROM
          fct_attestation_liveness_by_entity_head FINAL
      expected:
        total_from_aggregated: 685007
    - name: Verify both attestation_count and missed_count exist
      sql: |
        SELECT
          SUM(attestation_count) as total_attested,
          SUM(missed_count) as total_missed
        FROM
          fct_attestation_liveness_by_entity_head FINAL
        WHERE
          attestation_count >= 0 AND missed_count >= 0
      expected:
        total_attested: 683483
        total_missed: 1524
    - name: Expected admin bounds
      sql: |
        SELECT
          fromUnixTimestamp(MAX(position + interval)) AS max,
          fromUnixTimestamp(MIN(position)) AS min
        FROM
          admin_cbt_incremental FINAL
        WHERE
          table = 'fct_attestation_liveness_by_entity_head'
      expected:
        max: "2025-07-15T08:38:11Z"
        min: "2025-07-15T08:34:23Z"
