model: fct_node_cpu_utilization_by_process
network: mainnet
spec: pectra
external_data:
    observoor_cpu_utilization:
        url: https://data.ethpandaops.io/xatu-cbt/mainnet/pectra/fct_node_cpu_utilization_by_process_observoor_cpu_utilization.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS count FROM fct_node_cpu_utilization_by_process FINAL
      assertions:
        - type: greater_than
          column: count
          value: 0
    - name: No null wallclock_slot values
      sql: |
        SELECT COUNT(*) AS null_count FROM fct_node_cpu_utilization_by_process FINAL WHERE wallclock_slot IS NULL
      assertions:
        - type: equals
          column: null_count
          value: 0
    - name: No null meta_client_name values
      sql: |
        SELECT COUNT(*) AS null_count FROM fct_node_cpu_utilization_by_process FINAL WHERE meta_client_name IS NULL OR meta_client_name = ''
      assertions:
        - type: equals
          column: null_count
          value: 0
    - name: system_cores should be positive
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_node_cpu_utilization_by_process FINAL WHERE system_cores <= 0
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: mean_core_pct should be between min and max
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_node_cpu_utilization_by_process FINAL WHERE mean_core_pct < min_core_pct OR mean_core_pct > max_core_pct
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: min_core_pct should not exceed max_core_pct
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_node_cpu_utilization_by_process FINAL WHERE min_core_pct > max_core_pct
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: CPU percentages should be non-negative
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_node_cpu_utilization_by_process FINAL WHERE min_core_pct < 0 OR mean_core_pct < 0 OR max_core_pct < 0
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: node_class should only contain valid values
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_node_cpu_utilization_by_process FINAL WHERE node_class NOT IN ('eip7870', '')
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: node_class eip7870 matches meta_client_name containing 7870
      sql: |
        SELECT COUNT(*) AS mismatch_count FROM fct_node_cpu_utilization_by_process FINAL WHERE node_class = 'eip7870' AND positionCaseInsensitive(meta_client_name, '7870') = 0
      assertions:
        - type: equals
          column: mismatch_count
          value: 0
    - name: wallclock_slot_start_date_time should not be in the future
      sql: |
        SELECT COUNT(*) AS future_count FROM fct_node_cpu_utilization_by_process FINAL WHERE wallclock_slot_start_date_time > now() + INTERVAL 1 HOUR
      assertions:
        - type: equals
          column: future_count
          value: 0
