model: int_engine_new_payload_fastest
network: mainnet
spec: pectra
external_data:
    beacon_api_eth_v2_beacon_block:
        url: https://data.ethpandaops.io/xatu-cbt/mainnet/pectra/int_engine_new_payload_fastest_beacon_api_eth_v2_beacon_block.parquet
        network_column: meta_network_name
    execution_engine_new_payload:
        url: https://data.ethpandaops.io/xatu-cbt/mainnet/pectra/int_engine_new_payload_fastest_execution_engine_new_payload.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS count FROM int_engine_new_payload_fastest FINAL
      assertions:
        - type: greater_than
          column: count
          value: 0
    - name: Each slot and node_class pair should be unique (fastest only)
      sql: |
        SELECT COUNT(*) AS duplicate_count
        FROM (
            SELECT slot, node_class, COUNT(*) AS cnt
            FROM int_engine_new_payload_fastest FINAL
            GROUP BY slot, node_class
            HAVING cnt > 1
        )
      assertions:
        - type: equals
          column: duplicate_count
          value: 0
    - name: duration_ms should be non-negative
      sql: |
        SELECT COUNT(*) AS negative_duration_count
        FROM int_engine_new_payload_fastest FINAL
        WHERE duration_ms < 0
      assertions:
        - type: equals
          column: negative_duration_count
          value: 0
    - name: slot should be greater than zero
      sql: |
        SELECT COUNT(*) AS invalid_slot_count
        FROM int_engine_new_payload_fastest FINAL
        WHERE slot <= 0
      assertions:
        - type: equals
          column: invalid_slot_count
          value: 0
    - name: block_hash should not be empty
      sql: |
        SELECT COUNT(*) AS empty_block_hash_count
        FROM int_engine_new_payload_fastest FINAL
        WHERE block_hash = ''
      assertions:
        - type: equals
          column: empty_block_hash_count
          value: 0
    - name: meta_execution_implementation should not be empty (filtered in source)
      sql: |
        SELECT COUNT(*) AS empty_impl_count
        FROM int_engine_new_payload_fastest FINAL
        WHERE meta_execution_implementation = ''
      assertions:
        - type: equals
          column: empty_impl_count
          value: 0
    - name: epoch should be consistent with slot (slot / 32)
      sql: |
        SELECT COUNT(*) AS mismatched_epoch_count
        FROM int_engine_new_payload_fastest FINAL
        WHERE epoch != intDiv(slot, 32)
      assertions:
        - type: equals
          column: mismatched_epoch_count
          value: 0
    - name: updated_date_time should not be the zero value
      sql: |
        SELECT COUNT(*) AS zero_updated_count
        FROM int_engine_new_payload_fastest FINAL
        WHERE updated_date_time = toDateTime('1970-01-01 00:00:00')
      assertions:
        - type: equals
          column: zero_updated_count
          value: 0
    - name: duration_ms should be within a reasonable range (under 120 seconds)
      sql: |
        SELECT COUNT(*) AS unreasonable_duration_count
        FROM int_engine_new_payload_fastest FINAL
        WHERE duration_ms > 120000
      assertions:
        - type: equals
          column: unreasonable_duration_count
          value: 0
