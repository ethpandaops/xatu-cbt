model: fct_data_column_availability_by_slot
network: sepolia
spec: fusaka
external_data:
    beacon_api_eth_v2_beacon_block:
        url: https://data.ethpandaops.io/xatu-cbt/sepolia/fusaka/fct_data_column_availability_by_slot_beacon_api_eth_v2_beacon_block.parquet
        network_column: meta_network_name
    blob_submitter:
        url: https://data.ethpandaops.io/xatu-cbt/sepolia/fusaka/fct_data_column_availability_by_slot_blob_submitter.parquet
        network_column: meta_network_name
    execution_transaction:
        url: https://data.ethpandaops.io/xatu-cbt/sepolia/fusaka/fct_data_column_availability_by_slot_execution_transaction.parquet
        network_column: meta_network_name
    libp2p_gossipsub_data_column_sidecar:
        url: https://data.ethpandaops.io/xatu-cbt/sepolia/fusaka/fct_data_column_availability_by_slot_libp2p_gossipsub_data_column_sidecar.parquet
        network_column: meta_network_name
    libp2p_rpc_data_column_custody_probe:
        url: https://data.ethpandaops.io/xatu-cbt/sepolia/fusaka/fct_data_column_availability_by_slot_libp2p_rpc_data_column_custody_probe.parquet
        network_column: meta_network_name
    libp2p_synthetic_heartbeat:
        url: https://data.ethpandaops.io/xatu-cbt/sepolia/fusaka/fct_data_column_availability_by_slot_libp2p_synthetic_heartbeat.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS count FROM fct_data_column_availability_by_slot FINAL
      assertions:
        - type: greater_than
          column: count
          value: 0
    - name: Column index should be within valid data column range (0-127)
      sql: "SELECT \n  MIN(column_index) AS min_column_index,\n  MAX(column_index) AS max_column_index\nFROM fct_data_column_availability_by_slot FINAL\n"
      assertions:
        - type: greater_than_or_equal
          column: min_column_index
          value: 0
        - type: less_than_or_equal
          column: max_column_index
          value: 127
    - name: Probe count should equal sum of result counts
      sql: "SELECT \n  COUNT(*) AS row_count,\n  SUM(CASE WHEN probe_count = success_count + failure_count + missing_count THEN 0 ELSE 1 END) AS mismatched_rows\nFROM fct_data_column_availability_by_slot FINAL\n"
      assertions:
        - type: equals
          column: mismatched_rows
          value: 0
    - name: Availability percentage should be between 0 and 100
      sql: "SELECT \n  MIN(availability_pct) AS min_availability_pct,\n  MAX(availability_pct) AS max_availability_pct\nFROM fct_data_column_availability_by_slot FINAL\n"
      assertions:
        - type: greater_than_or_equal
          column: min_availability_pct
          value: 0
        - type: less_than_or_equal
          column: max_availability_pct
          value: 100
    - name: Counts should not be negative
      sql: "SELECT \n  SUM(CASE WHEN success_count < 0 THEN 1 ELSE 0 END) AS negative_success,\n  SUM(CASE WHEN failure_count < 0 THEN 1 ELSE 0 END) AS negative_failure,\n  SUM(CASE WHEN missing_count < 0 THEN 1 ELSE 0 END) AS negative_missing,\n  SUM(CASE WHEN probe_count < 0 THEN 1 ELSE 0 END) AS negative_probe\nFROM fct_data_column_availability_by_slot FINAL\n"
      assertions:
        - type: equals
          column: negative_success
          value: 0
        - type: equals
          column: negative_failure
          value: 0
        - type: equals
          column: negative_missing
          value: 0
        - type: equals
          column: negative_probe
          value: 0
    - name: Source attribution should sum to probe count
      sql: "SELECT \n  SUM(CASE WHEN custody_probe_count + gossipsub_count = probe_count THEN 0 ELSE 1 END) AS mismatched_source_counts\nFROM fct_data_column_availability_by_slot FINAL\n"
      assertions:
        - type: equals
          column: mismatched_source_counts
          value: 0
    - name: Response time percentiles should be ordered correctly when custody probes exist
      sql: "SELECT \n  SUM(CASE WHEN custody_probe_count > 0 AND min_response_time_ms > p50_response_time_ms THEN 1 ELSE 0 END) AS min_gt_p50,\n  SUM(CASE WHEN custody_probe_count > 0 AND p50_response_time_ms > p95_response_time_ms THEN 1 ELSE 0 END) AS p50_gt_p95,\n  SUM(CASE WHEN custody_probe_count > 0 AND p95_response_time_ms > p99_response_time_ms THEN 1 ELSE 0 END) AS p95_gt_p99,\n  SUM(CASE WHEN custody_probe_count > 0 AND p99_response_time_ms > max_response_time_ms THEN 1 ELSE 0 END) AS p99_gt_max\nFROM fct_data_column_availability_by_slot FINAL\n"
      assertions:
        - type: equals
          column: min_gt_p50
          value: 0
        - type: equals
          column: p50_gt_p95
          value: 0
        - type: equals
          column: p95_gt_p99
          value: 0
        - type: equals
          column: p99_gt_max
          value: 0
    - name: Epoch should be correctly derived from slot (slot DIV 32)
      sql: "SELECT \n  SUM(CASE WHEN epoch != toUInt32(slot DIV 32) THEN 1 ELSE 0 END) AS epoch_mismatch_count\nFROM fct_data_column_availability_by_slot FINAL\n"
      assertions:
        - type: equals
          column: epoch_mismatch_count
          value: 0
    - name: Unique counts should be positive when probe count is positive
      sql: "SELECT \n  SUM(CASE WHEN probe_count > 0 AND unique_peer_count = 0 THEN 1 ELSE 0 END) AS zero_peers_with_probes\nFROM fct_data_column_availability_by_slot FINAL\n"
      assertions:
        - type: equals
          column: zero_peers_with_probes
          value: 0
    # Sepolia BPO2 limit is 21 blobs per block
    - name: Blob count should be within reasonable range for PeerDAS
      sql: "SELECT \n  MIN(blob_count) AS min_blob_count,\n  MAX(blob_count) AS max_blob_count\nFROM fct_data_column_availability_by_slot FINAL\n"
      assertions:
        - type: greater_than_or_equal
          column: min_blob_count
          value: 0
        - type: less_than_or_equal
          column: max_blob_count
          value: 21
