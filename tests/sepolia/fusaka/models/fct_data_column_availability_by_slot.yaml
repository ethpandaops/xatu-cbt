model: fct_data_column_availability_by_slot
network: sepolia
spec: fusaka
external_data:
    libp2p_gossipsub_data_column_sidecar:
        url: https://data.ethpandaops.io/xatu-cbt/sepolia/fusaka/libp2p_gossipsub_data_column_sidecar.parquet
        network_column: meta_network_name
    libp2p_rpc_data_column_custody_probe:
        url: https://data.ethpandaops.io/xatu-cbt/sepolia/fusaka/libp2p_rpc_data_column_custody_probe.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT
          COUNT(*) AS count
        FROM
          fct_data_column_availability_by_slot FINAL
      expected: {}
    - name: Slot bounds should match test data range
      sql: |
        SELECT
          MIN(slot) AS min_slot,
          MAX(slot) AS max_slot
        FROM
          fct_data_column_availability_by_slot FINAL
      expected: {}
    - name: Column index should be in valid range (0-127)
      sql: |
        SELECT
          MIN(column_index) AS min_col,
          MAX(column_index) AS max_col
        FROM
          fct_data_column_availability_by_slot FINAL
      expected: {}
    - name: Availability percentage should be valid (0-100)
      sql: |
        SELECT
          MIN(availability_pct) AS min_pct,
          MAX(availability_pct) AS max_pct
        FROM
          fct_data_column_availability_by_slot FINAL
      expected: {}
    - name: Blob count should be reasonable (1-15)
      sql: |
        SELECT
          MIN(blob_count) AS min_blobs,
          MAX(blob_count) AS max_blobs
        FROM
          fct_data_column_availability_by_slot FINAL
      expected: {}
    - name: Probe count should be greater than zero
      sql: |
        SELECT
          MIN(probe_count) AS min_probes
        FROM
          fct_data_column_availability_by_slot FINAL
      expected: {}
    - name: Both custody probe and gossipsub sources should contribute data
      sql: |
        SELECT
          SUM(custody_probe_count) AS total_custody_probes,
          SUM(gossipsub_count) AS total_gossipsub
        FROM
          fct_data_column_availability_by_slot FINAL
      expected: {}
    - name: Source counts should sum correctly to probe count
      sql: |
        SELECT
          COUNT(*) AS rows_with_mismatch
        FROM
          fct_data_column_availability_by_slot FINAL
        WHERE probe_count != (custody_probe_count + gossipsub_count)
      expected: {}
    - name: Source attribution fields should be non-negative
      sql: |
        SELECT
          MIN(custody_probe_count) AS min_custody,
          MIN(gossipsub_count) AS min_gossipsub
        FROM
          fct_data_column_availability_by_slot FINAL
      expected: {}
