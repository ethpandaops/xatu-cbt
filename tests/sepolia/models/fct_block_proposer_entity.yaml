model: fct_block_proposer_entity
network: sepolia
external_data:
    beacon_api_eth_v1_events_block:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_block_proposer_entity_beacon_api_eth_v1_events_block.parquet
        network_column: meta_network_name
    beacon_api_eth_v1_events_block_gossip:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_block_proposer_entity_beacon_api_eth_v1_events_block_gossip.parquet
        network_column: meta_network_name
    beacon_api_eth_v1_proposer_duty:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_block_proposer_entity_beacon_api_eth_v1_proposer_duty.parquet
        network_column: meta_network_name
    ethseer_validator_entity:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_block_proposer_entity_ethseer_validator_entity.parquet
        network_column: meta_network_name
    libp2p_gossipsub_beacon_block:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_block_proposer_entity_libp2p_gossipsub_beacon_block.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS count FROM fct_block_proposer_entity FINAL
      assertions:
        - type: greater_than
          column: count
          value: 0
    - name: All rows should have valid slot values
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_block_proposer_entity FINAL WHERE slot < 0 OR slot IS NULL
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: All rows should have valid epoch values
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_block_proposer_entity FINAL WHERE epoch < 0 OR epoch IS NULL
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: Slot and epoch relationship should be consistent (32 slots per epoch)
      sql: |
        SELECT COUNT(*) AS inconsistent_count FROM fct_block_proposer_entity FINAL WHERE epoch != intDiv(slot, 32)
      assertions:
        - type: equals
          column: inconsistent_count
          value: 0
    - name: Slot start date time should not be null
      sql: |
        SELECT COUNT(*) AS null_count FROM fct_block_proposer_entity FINAL WHERE slot_start_date_time IS NULL
      assertions:
        - type: equals
          column: null_count
          value: 0
    - name: Epoch start date time should not be null
      sql: |
        SELECT COUNT(*) AS null_count FROM fct_block_proposer_entity FINAL WHERE epoch_start_date_time IS NULL
      assertions:
        - type: equals
          column: null_count
          value: 0
    - name: Updated date time should not be null
      sql: |
        SELECT COUNT(*) AS null_count FROM fct_block_proposer_entity FINAL WHERE updated_date_time IS NULL
      assertions:
        - type: equals
          column: null_count
          value: 0
    - name: Slot start date time should be before or equal to updated date time
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_block_proposer_entity FINAL WHERE slot_start_date_time > updated_date_time
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: Each slot should have at most one row per entity
      sql: |
        SELECT COUNT(*) AS duplicate_count FROM (SELECT slot, entity, COUNT(*) AS cnt FROM fct_block_proposer_entity FINAL GROUP BY slot, entity HAVING cnt > 1)
      assertions:
        - type: equals
          column: duplicate_count
          value: 0
    - name: Epoch start date time should align with slot start date time for epoch boundaries
      sql: |
        SELECT COUNT(*) AS misaligned_count FROM fct_block_proposer_entity FINAL WHERE slot % 32 = 0 AND epoch_start_date_time != slot_start_date_time
      assertions:
        - type: equals
          column: misaligned_count
          value: 0
