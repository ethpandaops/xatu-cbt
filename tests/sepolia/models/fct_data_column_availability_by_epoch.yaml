model: fct_data_column_availability_by_epoch
network: sepolia
external_data:
    beacon_api_eth_v2_beacon_block:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_epoch_beacon_api_eth_v2_beacon_block.parquet
        network_column: meta_network_name
    blob_submitter:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_epoch_blob_submitter.parquet
        network_column: meta_network_name
    execution_transaction:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_epoch_execution_transaction.parquet
        network_column: meta_network_name
    libp2p_gossipsub_data_column_sidecar:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_epoch_libp2p_gossipsub_data_column_sidecar.parquet
        network_column: meta_network_name
    libp2p_rpc_data_column_custody_probe:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_epoch_libp2p_rpc_data_column_custody_probe.parquet
        network_column: meta_network_name
    libp2p_synthetic_heartbeat:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_epoch_libp2p_synthetic_heartbeat.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS count FROM fct_data_column_availability_by_epoch FINAL
      assertions:
        - type: greater_than
          column: count
          value: 0
    - name: Epoch values should be non-negative
      sql: |
        SELECT MIN(epoch) AS min_epoch FROM fct_data_column_availability_by_epoch FINAL
      assertions:
        - type: greater_than_or_equal
          column: min_epoch
          value: 0
    - name: Column index should be within valid range (0-127 for data columns)
      sql: |
        SELECT MIN(column_index) AS min_col, MAX(column_index) AS max_col FROM fct_data_column_availability_by_epoch FINAL
      assertions:
        - type: greater_than_or_equal
          column: min_col
          value: 0
        - type: less_than_or_equal
          column: max_col
          value: 127
    - name: Slot count should be positive for each epoch-column combination
      sql: |
        SELECT MIN(slot_count) AS min_slot_count FROM fct_data_column_availability_by_epoch FINAL
      assertions:
        - type: greater_than
          column: min_slot_count
          value: 0
    - name: Probe counts should be non-negative and success + failure + missing should equal total
      sql: |
        SELECT
          MIN(total_probe_count) AS min_probe,
          MIN(total_success_count) AS min_success,
          MIN(total_failure_count) AS min_failure,
          MIN(total_missing_count) AS min_missing,
          SUM(CASE WHEN total_success_count + total_failure_count + total_missing_count != total_probe_count THEN 1 ELSE 0 END) AS count_mismatch
        FROM fct_data_column_availability_by_epoch FINAL
      assertions:
        - type: greater_than_or_equal
          column: min_probe
          value: 0
        - type: greater_than_or_equal
          column: min_success
          value: 0
        - type: greater_than_or_equal
          column: min_failure
          value: 0
        - type: greater_than_or_equal
          column: min_missing
          value: 0
        - type: equals
          column: count_mismatch
          value: 0
    - name: Availability percentage should be between 0 and 100
      sql: |
        SELECT
          MIN(avg_availability_pct) AS min_avail,
          MAX(avg_availability_pct) AS max_avail,
          MIN(min_availability_pct) AS min_min_avail,
          MAX(max_availability_pct) AS max_max_avail
        FROM fct_data_column_availability_by_epoch FINAL
      assertions:
        - type: greater_than_or_equal
          column: min_avail
          value: 0
        - type: less_than_or_equal
          column: max_avail
          value: 100
        - type: greater_than_or_equal
          column: min_min_avail
          value: 0
        - type: less_than_or_equal
          column: max_max_avail
          value: 100
    - name: Min availability should be less than or equal to max availability
      sql: |
        SELECT COUNT(*) AS invalid_range_count
        FROM fct_data_column_availability_by_epoch FINAL
        WHERE min_availability_pct > max_availability_pct
      assertions:
        - type: equals
          column: invalid_range_count
          value: 0
    - name: Response time percentiles should be ordered correctly (min <= p50 <= p95 <= p99 <= max)
      sql: |
        SELECT COUNT(*) AS invalid_percentile_order
        FROM fct_data_column_availability_by_epoch FINAL
        WHERE min_response_time_ms > avg_p50_response_time_ms
           OR avg_p50_response_time_ms > avg_p95_response_time_ms
           OR avg_p95_response_time_ms > avg_p99_response_time_ms
           OR avg_p99_response_time_ms > max_response_time_ms
      assertions:
        - type: equals
          column: invalid_percentile_order
          value: 0
    - name: Response times should be non-negative
      sql: |
        SELECT
          MIN(min_response_time_ms) AS min_resp,
          MIN(avg_p50_response_time_ms) AS min_p50,
          MIN(avg_p95_response_time_ms) AS min_p95,
          MIN(avg_p99_response_time_ms) AS min_p99,
          MIN(max_response_time_ms) AS min_max_resp
        FROM fct_data_column_availability_by_epoch FINAL
      assertions:
        - type: greater_than_or_equal
          column: min_resp
          value: 0
        - type: greater_than_or_equal
          column: min_p50
          value: 0
        - type: greater_than_or_equal
          column: min_p95
          value: 0
        - type: greater_than_or_equal
          column: min_p99
          value: 0
        - type: greater_than_or_equal
          column: min_max_resp
          value: 0
    - name: Max blob count should be non-negative
      sql: |
        SELECT MIN(max_blob_count) AS min_blob_count FROM fct_data_column_availability_by_epoch FINAL
      assertions:
        - type: greater_than_or_equal
          column: min_blob_count
          value: 0
