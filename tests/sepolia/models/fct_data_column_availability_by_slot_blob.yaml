model: fct_data_column_availability_by_slot_blob
network: sepolia
external_data:
    beacon_api_eth_v2_beacon_block:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_slot_blob_beacon_api_eth_v2_beacon_block.parquet
        network_column: meta_network_name
    blob_submitter:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_slot_blob_blob_submitter.parquet
        network_column: meta_network_name
    execution_transaction:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_slot_blob_execution_transaction.parquet
        network_column: meta_network_name
    libp2p_gossipsub_data_column_sidecar:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_slot_blob_libp2p_gossipsub_data_column_sidecar.parquet
        network_column: meta_network_name
    libp2p_rpc_data_column_custody_probe:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_slot_blob_libp2p_rpc_data_column_custody_probe.parquet
        network_column: meta_network_name
    libp2p_synthetic_heartbeat:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_by_slot_blob_libp2p_synthetic_heartbeat.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS count FROM fct_data_column_availability_by_slot_blob FINAL
      assertions:
        - type: greater_than
          column: count
          value: 0
    - name: Slot values should be positive
      sql: |
        SELECT MIN(slot) AS min_slot FROM fct_data_column_availability_by_slot_blob FINAL
      assertions:
        - type: greater_than_or_equal
          column: min_slot
          value: 0
    - name: Blob index should be within valid range (0 to blob_count-1)
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_data_column_availability_by_slot_blob FINAL WHERE blob_index >= blob_count OR blob_index < 0
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: Column index should be within valid range (0-127 for PeerDAS)
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_data_column_availability_by_slot_blob FINAL WHERE column_index < 0 OR column_index > 127
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: Availability percentage should be between 0 and 100
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_data_column_availability_by_slot_blob FINAL WHERE availability_pct < 0 OR availability_pct > 100
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: Probe count should equal sum of success, failure, and missing counts
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_data_column_availability_by_slot_blob FINAL WHERE probe_count != (success_count + failure_count + missing_count)
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: Count columns should be non-negative
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_data_column_availability_by_slot_blob FINAL WHERE success_count < 0 OR failure_count < 0 OR missing_count < 0 OR probe_count < 0
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: Response time percentiles should be in ascending order
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_data_column_availability_by_slot_blob FINAL WHERE min_response_time_ms > p50_response_time_ms OR p50_response_time_ms > p95_response_time_ms OR p95_response_time_ms > p99_response_time_ms OR p99_response_time_ms > max_response_time_ms
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: Blob count should be positive where data exists
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_data_column_availability_by_slot_blob FINAL WHERE blob_count <= 0
      assertions:
        - type: equals
          column: invalid_count
          value: 0
    - name: Unique counts should be non-negative
      sql: |
        SELECT COUNT(*) AS invalid_count FROM fct_data_column_availability_by_slot_blob FINAL WHERE unique_peer_count < 0 OR unique_client_count < 0 OR unique_implementation_count < 0
      assertions:
        - type: equals
          column: invalid_count
          value: 0
