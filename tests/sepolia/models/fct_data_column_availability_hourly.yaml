model: fct_data_column_availability_hourly
network: sepolia
external_data:
    beacon_api_eth_v2_beacon_block:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_hourly_beacon_api_eth_v2_beacon_block.parquet
        network_column: meta_network_name
    blob_submitter:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_hourly_blob_submitter.parquet
        network_column: meta_network_name
    execution_transaction:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_hourly_execution_transaction.parquet
        network_column: meta_network_name
    libp2p_gossipsub_data_column_sidecar:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_hourly_libp2p_gossipsub_data_column_sidecar.parquet
        network_column: meta_network_name
    libp2p_rpc_data_column_custody_probe:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_hourly_libp2p_rpc_data_column_custody_probe.parquet
        network_column: meta_network_name
    libp2p_synthetic_heartbeat:
        url: https://data.ethpandaops.io/xatu-cbt/tests/sepolia/fct_data_column_availability_hourly_libp2p_synthetic_heartbeat.parquet
        network_column: meta_network_name
assertions:
    - name: Row count should be greater than zero
      sql: |
        SELECT COUNT(*) AS count FROM fct_data_column_availability_hourly FINAL
      assertions:
        - type: greater_than
          column: count
          value: 0
    - name: Column index should be within valid range (0-127 for data columns)
      sql: "SELECT \n  MIN(column_index) AS min_column_index,\n  MAX(column_index) AS max_column_index\nFROM fct_data_column_availability_hourly FINAL\n"
      assertions:
        - type: greater_than_or_equal
          column: min_column_index
          value: 0
        - type: less_than_or_equal
          column: max_column_index
          value: 127
    - name: Availability percentage should be between 0 and 100
      sql: "SELECT \n  MIN(avg_availability_pct) AS min_avg_pct,\n  MAX(avg_availability_pct) AS max_avg_pct,\n  MIN(min_availability_pct) AS min_pct,\n  MAX(max_availability_pct) AS max_pct\nFROM fct_data_column_availability_hourly FINAL\n"
      assertions:
        - type: greater_than_or_equal
          column: min_avg_pct
          value: 0
        - type: less_than_or_equal
          column: max_avg_pct
          value: 100
        - type: greater_than_or_equal
          column: min_pct
          value: 0
        - type: less_than_or_equal
          column: max_pct
          value: 100
    - name: Probe counts should be non-negative and mathematically consistent
      sql: "SELECT \n  MIN(total_probe_count) AS min_probe_count,\n  MIN(total_success_count) AS min_success_count,\n  MIN(total_failure_count) AS min_failure_count,\n  MIN(total_missing_count) AS min_missing_count\nFROM fct_data_column_availability_hourly FINAL\n"
      assertions:
        - type: greater_than_or_equal
          column: min_probe_count
          value: 0
        - type: greater_than_or_equal
          column: min_success_count
          value: 0
        - type: greater_than_or_equal
          column: min_failure_count
          value: 0
        - type: greater_than_or_equal
          column: min_missing_count
          value: 0
    - name: Success count should not exceed total probe count
      sql: |
        SELECT COUNT(*) AS invalid_rows
        FROM fct_data_column_availability_hourly FINAL
        WHERE total_success_count > total_probe_count
      assertions:
        - type: equals
          column: invalid_rows
          value: 0
    - name: Response times should be non-negative and p50 <= p95 <= p99 <= max
      sql: "SELECT \n  MIN(min_response_time_ms) AS min_response,\n  COUNT(CASE WHEN avg_p50_response_time_ms > avg_p95_response_time_ms THEN 1 END) AS p50_gt_p95_count,\n  COUNT(CASE WHEN avg_p95_response_time_ms > avg_p99_response_time_ms THEN 1 END) AS p95_gt_p99_count,\n  COUNT(CASE WHEN avg_p99_response_time_ms > max_response_time_ms THEN 1 END) AS p99_gt_max_count\nFROM fct_data_column_availability_hourly FINAL\n"
      assertions:
        - type: greater_than_or_equal
          column: min_response
          value: 0
        - type: equals
          column: p50_gt_p95_count
          value: 0
        - type: equals
          column: p95_gt_p99_count
          value: 0
        - type: equals
          column: p99_gt_max_count
          value: 0
    - name: Epoch count should be positive for all hourly aggregations
      sql: |
        SELECT MIN(epoch_count) AS min_epoch_count
        FROM fct_data_column_availability_hourly FINAL
      assertions:
        - type: greater_than
          column: min_epoch_count
          value: 0
    - name: Hour start date time should not have null values
      sql: |
        SELECT COUNT(*) AS null_count
        FROM fct_data_column_availability_hourly FINAL
        WHERE hour_start_date_time IS NULL
      assertions:
        - type: equals
          column: null_count
          value: 0
    - name: Min availability should not exceed max availability
      sql: |
        SELECT COUNT(*) AS invalid_rows
        FROM fct_data_column_availability_hourly FINAL
        WHERE min_availability_pct > max_availability_pct
      assertions:
        - type: equals
          column: invalid_rows
          value: 0
    - name: Blob count should be non-negative
      sql: |
        SELECT MIN(max_blob_count) AS min_blob_count
        FROM fct_data_column_availability_hourly FINAL
      assertions:
        - type: greater_than_or_equal
          column: min_blob_count
          value: 0
